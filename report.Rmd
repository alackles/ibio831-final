---
title: "Project"
author: "Acacia, Kate, Julia"
date: "3/23/2021"
output: 
      html_document: default
      pdf_document: default
---

```{r setup, include=FALSE}
set.seed(1)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)            
```

## Scenario
Genes A and B have both been shown to be related to lifetime chance of cancer. We want to know if an organism with gene A has the same chance of cancer as an organism with gene B, and how that differs when an organism has both genes A and B, or neither gene. We need to include the covariate of the organism’s mass, because we know this also affects the lifetime chance of cancer. 

We sample N organisms of each of the four genotypes, and we record their body mass and whether or not cancer is present in that organism. 

### Story

Your lab is studying cancer-related genes using feline mammary carcinomas (FMCs) to both validate these tumors as models for human breast cancer (HBC) studies and to improve small animal veterinary practice. FMCs have been emerging as valuable models for human breast cancer, and the domestic cat is highly affected by spontaneous mammary tumors (Ferreira et al., 2019).
 
The cancer-related genes A and B are conserved between cat and human. Both genes have been shown to be related to lifetime incidence of HBC, but they have not been studied in cats. You want to know if a cat with gene A has the same lifetime chance of developing a FMC as a cat with gene B, and how that differs when an organism has both genes A and B, or neither gene (wild type).
 
A cat’s breed, sex, age, and whether or not it is intact all greatly influence their lifetime risk of FMCs (Ohio State University Veterinary Medical Center, 2021). To control for these factors, you use only intact female domestic shorthair cats that are 10 years and older (which show the highest incidence of FMCs) as study subjects. A cat’s mass affects their lifetime chance of cancer as well. 

Working with the MSU Small Animal Clinic, you recruit 100 participants for the study: 25 with gene A, 25 with gene B, 25 with both genes A and B, and 25 with neither gene. For each cat, you record its genotype, mass at time of death and whether or not it had a FMC in its lifetime. Your null hypothesis is that the lifetime chance of developing a FMC is equal across all four genotypes. Your alternative hypothesis is that the lifetime chance of developing a FMC is different between genotypes.


Ferreira D, Martins B, Soares M, Correia J, Adega F, et al. (2019) Gene expression association study in feline mammary carcinomas. PLOS ONE 14(8): e0221776. https://doi.org/10.1371/journal.pone.0221776

Ohio State University Veterinary Medical Center (2021) Feline Mammary Tumors. Retrieved from https://vet.osu.edu/vmc/companion/our-services/oncology-and-hematology/common-tumor-types/feline-mammary-tumors


### Hypothesis

_Null Hypothesis_: The probability of cancer is equal across all genotypes.

_Alternative Hypothesis 1 (no interaction effect)_: A, B, and AB all show a higher probability of cancer than WT, where A+B = AB.

_Alternative Hypothesis 2 (interaction effect increases probability)_: A, B, and AB all show a higher probability of cancer than WT, where A + B > AB.

_Alternative Hypothesis 3 (interaction effect decreases probability)_: A, B, and AB all show a higher probability of cancer than WT, where A + B < AB.



### Variables

_Genotypes_: WT (neither A nor B), A, B, and AB. A and B each have an incidence rate for cancer.

_Mass_: a continuous variable between 7 and 15 lbs

_Genotype A x Genotype B_: Interaction effects

_Response variable_: Presence or absence of cancer in the organism (0/1) 

_Predictor variables_: Genotype A, Genotype B, interaction between Genotypes A & B, and organism mass 


## Modeling and Justification


**Binomial Distribution**

$y \sim Bin(p,N)$

- $p$ is probability of cancer
- $N$ is total number of individuals

_Justification_: We measure cancer as either present/ absent in each organism. The data simulation evolves N multicellular individuals. We have fixed N number of trials that we can repeat _ad infinitum_. This is a frequentists' approach. Hence, we chose the Binomial distribution.

**Deterministic Function (model) & Joint Probability (likelihood)**

$counts = \alpha + \beta_1 * genotype_A + \beta_2 * genotype_B + \delta * genotype_A * genotype_B + \gamma * mass + \epsilon$

- $counts$ = expected number of organisms with cancer present
- $\alpha$ = (intercept) -- expected incidence rate of cancer in wildtype reference
- $\beta_1$ = constant for $genotype_A$ (how much gene A influences incidence of cancer)
- $\beta_2$ = constant for $genotype_B$ (how much gene B influences incidence of cancer)
- $\delta$ = slope term indicating the interaction between genes A and B (how much genes A and B combined influence incidence of cancer)
- $\gamma$ = constant for mass (how much organism mass influences incidence of cancer)
- $\epsilon$ = randomness pulled from binomial distribution
  + $\epsilon \sim Bin(p,N)$

---

## Simulate the Data

```{r packages, message=FALSE}
#Install packages if necessary
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("GGally")
#install.packages("lme4")
#install.packages("boot")
#install.packages("bbmle")
# Load packages
library(dplyr) # for data
library(tidyr) # also data
library(ggplot2) # for plotting
library(GGally) # for ggpairs function, pairwise plotting of multiple variables
library(lme4) # for GLMMs
library(boot) # inv.logit function
library(bbmle) # for AICctab function, convient way to compare models
```
```{r simulate}
### Same random seed
set.seed(12345)
#### Number of Datapoints ####
# Assume a balanced design
# 2 genes - A and B
# number of cats looked at
n <- 1000
#### Data Simulation ####

# Specify a categorical variable which indicates genotype
genA <- factor(rep(rep(c(0,1), each=n/4),2)) # produces 00...11...00...11...
genB <- factor(rep(c(0,1), each=n/2)) # produces 0000...1111....
types <- c("WT", "A", "B", "AB")
genotype <- factor(rep(types, each=n/4))

# We also need a vector to indicate mass for each organism
weights <- 7:14
mass <- rep(7:14, length.out=n)

# Chose the values for the parameters (logit transformed)
# Labeled to make it easier to think about
# Each element in beta.vec.names indicates the effect of that variable or interaction of variables
beta.vec.names <- c("WT", "A", "B", "A:B", "mass")

# this is nonlinear transformation on the logit scale, so 0.02 does NOT mean 2% increase in prob. of cancer!!!
# small change in these params will cause MAJOR changes because on logit scale
# A:B is the amount of EXTRA change on top of A+B, so anything over zero is an interaction effect
beta.vec <- c(0, 0.3, 0.2, 0.05, 0.05) 
names(beta.vec) <- beta.vec.names

#### Model Matrix Creation ####

# Build the design matrix of the interactive combination of genotype and mass
Xmat = model.matrix(~genA*genB + mass)

#### Create Stochastic Data ####

#Generate the linear predictor (mutliple Xmat by the beta.vec)
lin.pred =  Xmat[,]%*%beta.vec

#Transform the data with an inverse logit to get the expected proportion of cancerous samples
exp.p <- exp(lin.pred)/(1+exp(lin.pred))

# Add binomial noise
cancer.counts <- rbinom(n=n, size=1, prob=exp.p)

#### Combine Data ####
# Combine type data, mass data, and cancer counts
df <- data.frame(genA, genB, mass, genotype, cancer.counts)

#### Data pre-processing ####
cancer.table <- df %>%
  group_by(genotype, mass, genA, genB) %>%
  count(cancer.counts) %>%
  spread(cancer.counts, n) %>%
  rename(healthy="0", cancer="1")
cancer.table$genotype <- factor(cancer.table$genotype, levels=c("WT", "A","B", "AB"))
cancer.table$cancer.prop <- (cancer.table$cancer)/(cancer.table$cancer + cancer.table$healthy)

```

## Data 

```{r}
# Look at our data... a little bit
head(df, n=15)
head(cancer.table, n=15)
```
---

## Parameter estimation method

```{r models}
cancer.table$mass.scaled <- cancer.table$mass - 10.5
null.model <- glm(cbind(healthy,cancer) ~ 1, data=cancer.table,binomial(link="logit"))
mass.model <- glm(cbind(healthy,cancer) ~ mass.scaled, data=cancer.table,binomial(link="logit"))
no.interaction.model <- glm(cbind(healthy,cancer)  ~ genA + genB + mass.scaled, data=cancer.table,binomial(link="logit"))
interaction.model <- glm(cbind(healthy,cancer)  ~ genA*genB + mass.scaled, data=cancer.table,binomial(link="logit"))
summary(null.model)
summary(mass.model)
summary(no.interaction.model)
summary(interaction.model)
```

---

## Plots

Here, we present our raw data compared to the options for our models.

```{r}

plt <- ggplot(data=cancer.table, aes(x=mass.scaled, y=cancer.prop, color=genotype)) + geom_jitter() + ylim(0,1)

null.plt <- plt + geom_hline(yintercept=inv.logit(coef(null.model)[[1]]))
null.plt

coef.mass <- inv.logit(coef(mass.model))
mass.plt <- plt + geom_abline(intercept = coef.mass[[1]], slope = coef.mass[[2]])
mass.plt
```


---

## Statistical Test of Models and Model Comparison

We compare our models--a null model, a model with additive effects only, and a model with interaction effects--using Akaike Information Content (AIC). The following table lists the models from lowest to highest AIC ("best" to "worst" model, loosely).

```{r comparison}
#### Model Comparison ####
models <- list(null.model, mass.model, no.interaction.model, interaction.model)
model.names <- c("null", "mass","additive", "interaction")

### AIC ###
AICtab = AICctab(null.model, mass.model, no.interaction.model, interaction.model, base=TRUE, delta=TRUE, weights=TRUE, logLik=TRUE)
class(AICtab) = 'data.frame'
AICtab
plot(logLik ~ df, data=AICtab)  # loglikelihood ratio test relative to null.model
plot(AICc ~ df, data=AICtab)    # dAIC test relative to null.model

# Based on the logLik plots relative to degrees of freedom, the jump in logliklihood occurs for no.interaction.model. 

# Based on the AICc relative degrees of freedom plot, no.interaction.model and interaction.model are both dAIC > 2 and are thus significantly different from null.model.


#### Model Averaging ####
# We decided to try model averaging with the top three models from AICtab whose weights total 96%. 
# Data simulation
n<-1000
types <- c("WT", "A", "B", "AB")
sim_genotype <- factor(rep(types, each=n/4))
simdata <- data.frame(genotype=sim_genotype,mass=rep(7:14, length.out=n), cancer.counts=rbinom(n=n, size=1, prob=exp.p))

# group by mass category
simdata.table <- simdata %>%
  group_by(genotype, mass) %>%
  count(cancer.counts) %>%
  spread(cancer.counts, n) %>%
  rename(healthy="0", cancer="1")
simdata.table$cancer.prop <- (simdata.table$cancer)/(simdata.table$cancer + simdata.table$healthy)
simdata.table$mass.scaled <- scale(simdata.table$mass)

# Calculate predictions by hand
p_null <-  inv.logit(null.model$coefficients[["(Intercept)"]] + 0 * simdata.table$cancer.prop)        # null predictions
p_mass <- inv.logit(mass.model$coefficients[["(Intercept)"]] + 
            mass.model$coefficients[["mass.scaled"]] * simdata.table$cancer.prop)                           # mass predictions
p_add <- inv.logit(no.interaction.model$coefficients[["(Intercept)"]] + 
            no.interaction.model$coefficients[["genA1"]] * simdata.table$cancer.prop +
            no.interaction.model$coefficients[["genB1"]] * simdata.table$cancer.prop +
            no.interaction.model$coefficients[["mass.scaled"]] * simdata.table$cancer.prop)                 # additive predictions
#p_inter = inv.logit(interaction.model$coefficients[["(Intercept)"]] + 
#            interaction.model$coefficients[["genA1"]] * simdata.table$cancer.prop +
#            interaction.model$coefficients[["genB1"]] * simdata.table$cancer.prop +
#            interaction.model$coefficients[["mass.scaled"]] * simdata.table$cancer.prop + 
#            interaction.model$coefficients[["genA1:genB1"]] * simdata.table$cancer.prop)             # interaction predictions

# Calculate model averaged predictions

# weights are from AICtab. This corresponds directly to AICtab.
#pAVG = p_null * AICtab$weight[1] + 
#  p_mass * AICtab$weight[2] + 
#  p_add * AICtab$weight[3] + 
#  p_inter * AICtab$weight[4]
pAVG <- p_null * AICtab$weight[1] + p_mass * AICtab$weight[2] + p_add * AICtab$weight[3]

# add to simdata table
simdata.table$p_null <- p_null
simdata.table$p_mass <- p_mass
simdata.table$p_add <- p_add
#simdata.table$p_inter <- p_inter
simdata.table$pAVG <- pAVG

# Plot observations and the three sets of predictions
#lines(p_null ~ mass, data=sim, lwd=2, col="cyan")
#lines(p_mass ~ mass, data=sim, lwd=2, col="blue")
sim <- filter(simdata.table, genotype=='WT')
{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='WT'),ylim=c(0,1))
lines(p_null ~ mass, data=sim, lwd=2, col="cyan")
lines(p_mass ~ mass, data=sim, lwd=2, col="blue")
lines(p_add ~ mass, data=sim, lwd=2, col="black")
lines(pAVG ~ mass, data=sim, lwd=2, col='red')}

sim <- filter(simdata.table, genotype=='A')
{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='A'),ylim=c(0,1))
lines(p_null ~ mass, data=sim, lwd=2, col="cyan")
lines(p_mass ~ mass, data=sim, lwd=2, col="blue")
lines(p_add ~ mass, data=sim, lwd=2, col="black")
lines(pAVG ~ mass, data=sim, lwd=2, col='red')}

sim <- filter(simdata.table, genotype=='B')
{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='B'),ylim=c(0,1))
lines(p_null ~ mass, data=sim, lwd=2, col="cyan")
lines(p_mass ~ mass, data=sim, lwd=2, col="blue")
lines(p_add ~ mass, data=sim, lwd=2, col="black")
lines(pAVG ~ mass, data=sim, lwd=2, col='red')}

sim <- filter(simdata.table, genotype=='AB')
{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='AB'),ylim=c(0,1))
lines(p_null ~ mass, data=sim, lwd=2, col="cyan")
lines(p_mass ~ mass, data=sim, lwd=2, col="blue")
lines(p_add ~ mass, data=sim, lwd=2, col="black")
lines(pAVG ~ mass, data=sim, lwd=2, col='red')}

# Model averaging doesn't seem to help, which makes sense since parameters are only useful in context of its own model.
```

We can see that interaction model is the model with the lowest AIC; however, the next-highest model, the additive, only has a $\Delta$AIC of 1.9. This may or may not be meaningfully different.

---

## Effect Size Analysis

```{r}
#### Effect of Genotype on Cancer Risk ####

avgmass <- mean(cancer.table$mass)     # 10.5 
# Filter cats that are 10 and 11 lb so that we evaluate on average 10.5 lb cats 
cancer.table.avgmass <- cancer.table %>% filter(mass == 10 | mass==11)

## no.interaction.model ##
no.interaction.model.avgmass <- glm(cancer.prop  ~ genA + genB + mass.scaled, data=cancer.table.avgmass,binomial(link="logit"))

summary(no.interaction.model.avgmass)
#Coefficients:
#            Estimate Std. Error z value Pr(>|z|)
#(Intercept)   0.2814     1.2537   0.224    0.822
#genA1         0.2500     1.4873   0.168    0.866
#genB1         0.3890     1.4887   0.261    0.794
#mass.scaled   0.2461     3.4604   0.071    0.943

genB_div_genA <- no.interaction.model.avgmass$coefficients[["genB1"]] /no.interaction.model.avgmass$coefficients[["genA1"]]
genB_div_genA - 1     # 0.5557101
# Presence of Gene B leads to 55.57% greater change in lifetime cancer risk compared to presence of Gene A under the no.interaction.model for cats that are 10 to 11 lb mass.


## interaction.model ##
interaction.model.avgmass<- glm(cancer.prop  ~ genA*genB + mass.scaled, data=cancer.table.avgmass,binomial(link="logit"))

summary(interaction.model.avgmass)
#Coefficients:
#            Estimate Std. Error z value Pr(>|z|)
#(Intercept)   0.1943     1.4214   0.137    0.891
#genA1         0.4305     2.0550   0.209    0.834
#genB1         0.5736     2.0811   0.276    0.783
#mass.scaled   0.2467     3.4644   0.071    0.943
#genA1:genB1  -0.3811     2.9812  -0.128    0.898

genB_div_genA <- interaction.model.avgmass$coefficients[["genB1"]] /interaction.model.avgmass$coefficients[["genA1"]]
genB_div_genA - 1     # 0.3325344
# Presence of Gene B leads to 33.25% greater change in lifetime cancer risk compared to presence of Gene A under the interaction.model for cats that are 10 to 11 lb mass.

genAB_div_genA <- interaction.model.avgmass$coefficients[["genA1:genB1"]] /interaction.model.avgmass$coefficients[["genA1"]]
genAB_div_genA - 1     # -1.885328
# Presence of both Gene A and B leads to 188.53% decrease change in lifetime cancer risk compared to presence of Gene A under the interaction.model for cats that are 10 to 11 lb mass.

genAB_div_genB <- interaction.model.avgmass$coefficients[["genA1:genB1"]] /interaction.model.avgmass$coefficients[["genB1"]]
genAB_div_genB - 1     # -1.664394
# Presence of both Gene A and B leads to 166.44% decrease change in lifetime cancer risk compared to presence of Gene B under the interaction.model for cats that are 10 to 11 lb mass.


#### Effect of Mass on Cancer Risk ####
unscaled_mass_model <- glm(cancer.prop ~ mass, data=cancer.table,binomial(link="logit"))
control <- inv.logit(unscaled_mass_model$coefficients[['(Intercept)']])
account_for_mass <- inv.logit(unscaled_mass_model$coefficients[['mass']])
effect_of_accounting_for_mass <- account_for_mass - control
effect_of_accounting_for_mass         #  0.1018492

# The effect for every increased pound in a cat's mass is -10.8% increase in lifetime cancer risk.  
```
---
## Confidence Intervals

```{r}
#### 95% Confidence Interval for the 2 significant models (result of model comparison) ####

### no.interaction.model ###
#m = glm(cancer.prop ~ mass, data=cancer.table,family="binomial")
m <- glm(cancer.prop  ~ genA + genB + mass, data=cancer.table,binomial(link="logit"))
#### Simulate data to compare observations and predicted means ####
n<-1000
types <- c("WT", "A", "B", "AB")
sim_genotype <- factor(rep(types, each=n/4))
simdata <- data.frame(genotype=sim_genotype,mass=rep(7:14, length.out=n), cancer.counts=rbinom(n=n, size=1, prob=exp.p))

# group by mass category
simdata.table <- simdata %>%
  group_by(genotype, mass) %>%
  count(cancer.counts) %>%
  spread(cancer.counts, n) %>%
  rename(healthy="0", cancer="1")
simdata.table$cancer.prop <- (simdata.table$cancer)/(simdata.table$cancer + simdata.table$healthy)

# 95% confidence interval calculation
pred.m <- predict(m, data=simdata.table, se.fit=TRUE, type='response')
pred <- pred.m$fit
lower <- pred.m$fit - 1.96 * pred.m$se.fit
upper <- pred.m$fit + 1.96 * pred.m$se.fit

simdata.table$pred <- pred
simdata.table$lower <- lower
simdata.table$upper <- upper

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='WT'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='WT'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='WT'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='WT'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='A'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='A'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='A'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='A'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='B'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='B'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='B'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='B'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='AB'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='AB'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='AB'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='AB'))}
# This was a poor model.





### interaction.model ###
m <- glm(cancer.prop  ~ genA * genB + mass, data=cancer.table,binomial(link="logit"))
#### Simulate data to compare observations and predicted means ####
types <- c("WT", "A", "B", "AB")
sim_genotype <- factor(rep(types, each=n/4))
simdata <- data.frame(genotype=sim_genotype,mass=rep(7:14, length.out=n), cancer.counts=rbinom(n=n, size=1, prob=exp.p))

# group by mass category
simdata.table <- simdata %>%
  group_by(genotype, mass) %>%
  count(cancer.counts) %>%
  spread(cancer.counts, n) %>%
  rename(healthy="0", cancer="1")
simdata.table$cancer.prop <- (simdata.table$cancer)/(simdata.table$cancer + simdata.table$healthy)

# 95% confidence interval calculation
pred.m <- predict(m, data=simdata.table, se.fit=TRUE, type='response')
pred <- pred.m$fit
lower <- pred.m$fit - 1.96 * pred.m$se.fit
upper <- pred.m$fit + 1.96 * pred.m$se.fit

simdata.table$pred <- pred
simdata.table$lower <- lower
simdata.table$upper <- upper

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='WT'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='WT'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='WT'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='WT'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='A'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='A'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='A'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='A'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='B'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='B'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='B'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='B'))}

{plot(cancer.prop ~ mass, data=filter(cancer.table, genotype=='AB'), ylim = c(0,1))
lines(pred ~ mass, data=filter(simdata.table, genotype=='AB'))
lines(lower ~ mass, data=filter(simdata.table, genotype=='AB'))
lines(upper ~ mass, data=filter(simdata.table, genotype=='AB'))}

# This was a poor model.
```

---
## Interpretation of Model Results
