---
title: "Project"
author: "Acacia, Kate, Julia"
date: "3/23/2021"
output: 
      html_document: default
      pdf_document: default
---

```{r setup, include=FALSE}
set.seed(1)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)            
```

## Scenario
Genes A and B have both been shown to be related to lifetime chance of cancer. We want to know if an organism with gene A has the same chance of cancer as an organism with gene B, and how that differs when an organism has both genes A and B, or neither gene. We need to include the covariate of the organism’s mass, because we know this also affects the lifetime chance of cancer. 

We sample N organisms of each of the four genotypes, and we record their body mass and whether or not cancer is present in that organism. 

### Story

Your lab is studying cancer-related genes using feline mammary carcinomas (FMCs) to both validate these tumors as models for human breast cancer (HBC) studies and to improve small animal veterinary practice. FMCs have been emerging as valuable models for human breast cancer, and the domestic cat is highly affected by spontaneous mammary tumors (Ferreira et al., 2019).
 
The cancer-related genes A and B are conserved between cat and human. Both genes have been shown to be related to lifetime incidence of HBC, but they have not been studied in cats. You want to know if a cat with gene A has the same lifetime chance of developing a FMC as a cat with gene B, and how that differs when an organism has both genes A and B, or neither gene (wild type).
 
A cat’s breed, sex, age, and whether or not it is intact all greatly influence their lifetime risk of FMCs (Ohio State University Veterinary Medical Center, 2021). To control for these factors, you use only intact female domestic shorthair cats that are 10 years and older (which show the highest incidence of FMCs) as study subjects. A cat’s mass affects their lifetime chance of cancer as well. 

Working with the MSU Small Animal Clinic, you recruit 100 participants for the study: 25 with gene A, 25 with gene B, 25 with both genes A and B, and 25 with neither gene. For each cat, you record its genotype, mass at time of death and whether or not it had a FMC in its lifetime. Your null hypothesis is that the lifetime chance of developing a FMC is equal across all four genotypes. Your alternative hypothesis is that the lifetime chance of developing a FMC is different between genotypes.


Ferreira D, Martins B, Soares M, Correia J, Adega F, et al. (2019) Gene expression association study in feline mammary carcinomas. PLOS ONE 14(8): e0221776. https://doi.org/10.1371/journal.pone.0221776

Ohio State University Veterinary Medical Center (2021) Feline Mammary Tumors. Retrieved from https://vet.osu.edu/vmc/companion/our-services/oncology-and-hematology/common-tumor-types/feline-mammary-tumors


### Hypothesis

_Null Hypothesis_: The probability of cancer is equal across all genotypes.

_Alternative Hypothesis 1 (no interaction effect)_: A, B, and AB all show a higher probability of cancer than WT, where A+B = AB.

_Alternative Hypothesis 2 (interaction effect increases probability)_: A, B, and AB all show a higher probability of cancer than WT, where A + B > AB.

_Alternative Hypothesis 3 (interaction effect decreases probability)_: A, B, and AB all show a higher probability of cancer than WT, where A + B < AB.



### Variables

_Genotypes_: WT (neither A nor B), A, B, and AB. A and B each have an incidence rate for cancer.

_Mass_: a continuous variable between 7 and 15 lbs

_Genotype A x Genotype B_: Interaction effects

_Response variable_: Presence or absence of cancer in the organism (0/1) 

_Predictor variables_: Genotype A, Genotype B, interaction between Genotypes A & B, and organism mass 


## Modeling and Justification


**Binomial Distribution**

$y \sim Bin(p,N)$

- $p$ is probability of cancer
- $N$ is total number of individuals

_Justification_: We measure cancer as either present/ absent in each organism. The data simulation evolves N multicellular individuals. We have fixed N number of trials that we can repeat _ad infinitum_. This is a frequentists' approach. Hence, we chose the Binomial distribution.

**Deterministic Function (model) & Joint Probability (likelihood)**

$counts = \alpha + \beta_1 * genotype_A + \beta_2 * genotype_B + \delta * genotype_A * genotype_B + \gamma * mass + \epsilon$

- $counts$ = expected number of organisms with cancer present
- $\alpha$ = (intercept) -- expected incidence rate of cancer in wildtype reference
- $\beta_1$ = constant for $genotype_A$ (how much gene A influences incidence of cancer)
- $\beta_2$ = constant for $genotype_B$ (how much gene B influences incidence of cancer)
- $\delta$ = slope term indicating the interaction between genes A and B (how much genes A and B combined influence incidence of cancer)
- $\gamma$ = constant for mass (how much organism mass influences incidence of cancer)
- $\epsilon$ = randomness pulled from binomial distribution
  + $\epsilon \sim Bin(p,N)$

---

## Simulate the Data

```{r packages}
#Install packages if necessary
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("GGally")
#install.packages("lme4")
#install.packages("AICcmodavg")

# Load packages
library(dplyr) # for data
library(tidyr) # also data
library(ggplot2) # for plotting
library(GGally) # for ggpairs function, pairwise plotting of multiple variables
library(lme4) # for GLMMs
library(AICcmodavg) # for AIC comparison
```
```{r simulate}
### Same random seed
set.seed(12345)
#### Number of Datapoints ####
# Assume a balanced design
# 2 genes - A and B
# number of cats looked at
n <- 1000


#### Data Simulation ####

# Specify a categorical variable which indicates genotype
genA <- factor(rep(rep(c(0,1), each=n/4),2)) # produces 00...11...00...11...
genB <- factor(rep(c(0,1), each=n/2)) # produces 0000...1111....
types <- c("WT", "A", "B", "AB")
genotype <- factor(rep(types, each=n/4))

# We also need a vector to indicate mass for each organism

weights <- 7:14
mass <- rep(7:14, length.out=1000)

# Chose the values for the parameters (logit transformed)
# Labeled to make it easier to think about
# Each element in beta.vec.names indicates the effect of that variable or interaction of variables
beta.vec.names <- c("WT", "A", "B", "A:B", "mass")
# this is nonlinear transformation on the logit scale, so 0.02 does NOT mean 2% increase in prob. of cancer!!!
# small change in these params will cause MAJOR changes because on logit scale
# A:B is the amount of EXTRA change on top of A+B, so anything over zero is an interaction effect
beta.vec <- c(0, 0.3, 0.2, 0.05, 0.05) 
names(beta.vec) <- beta.vec.names


#### Model Matrix Creation ####
# Build the design matrix of the interactive combination of genotype and mass
Xmat = model.matrix(~genA*genB + mass)

#### Create Stochastic Data ####
#Generate the linear predictor (mutliple Xmat by the beta.vec)
lin.pred =  Xmat[,]%*%beta.vec

#Transform the data with an inverse logit to get the expected proportion of cancerous samples
exp.p <- exp(lin.pred)/(1+exp(lin.pred))

# Add binomial noise
cancer.counts <- rbinom(n=n, size=1, prob=exp.p)

#### Combine Data ####
# Combine type data, mass data, and cancer counts
df <- data.frame(genA, genB, mass, genotype, cancer.counts)
df

#### Export ####
# Export the data to a csv file
#filename <- "cancer_data.csv"
#write.csv(df, file=filename, row.names = FALSE)
```

---

## Parameter estimation method

```{r models}
null.model <- glm(cancer.counts ~ mass, data=df,binomial(link="logit"))
no.interaction.model <- glm(cancer.counts  ~ genA + genB + mass, data=df,binomial(link="logit"))
interaction.model <- glm(cancer.counts  ~ genA*genB + mass, data=df,binomial(link="logit"))
summary(null.model)
summary(no.interaction.model)
summary(interaction.model)

```

---

## Statistical Test of Models and Model Comparison

We compare our models--a null model, a model with additive effects only, and a model with interaction effects--using Akaike Information Content (AIC). The following table lists the models from lowest to highest AIC ("best" to "worst" model, loosely).

```{r comparison}
models <- list(null.model, no.interaction.model, interaction.model)
model.names <- c("null", "additive", "interaction")
aictab(cand.set = models, modnames = model.names)

```

We can see that interaction model is the model with the lowest AIC; however, the next-highest model, the additive, only has a $\Delta$AIC of 0.81. This indicates the models are not meaningfully different from one another.

<!--TODO: Discuss effect size?-->

---
## Plots

```{r, echo=FALSE}
cancer.table <- df %>%
  group_by(genotype, mass) %>%
  count(cancer.counts) %>%
  spread(cancer.counts, n) %>%
  rename(healthy="0", cancer="1")

cancer.table$cancer.prop <- (cancer.table$cancer)/(cancer.table$cancer + cancer.table$healthy)
# 
ggplot(data=cancer.table, aes(x=mass, y=cancer.prop, color=genotype)) + geom_jitter()

```

---
## Analysis of Effect & Uncertainty Sizes

```{r}



```

---
## Interpretation of Model Results

